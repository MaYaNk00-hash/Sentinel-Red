import type { Vulnerability, VulnerabilityFilter } from '@/types/vulnerability'

const mockVulnerabilities: Vulnerability[] = [
  {
    id: 'vuln-1',
    scan_id: 'scan-1',
    title: 'SQL Injection in Login',
    description: 'The login endpoint is vulnerable to SQL injection via the username parameter. An attacker can bypass authentication or extract data.',
    severity: 'critical',
    type: 'Input Validation',

    discovered_at: new Date(Date.now() - 86400000).toISOString(),
    impact: 'High - Data Breach',
    exploit_complexity: 'low',
    cvss_score: 9.8,
    affected_endpoints: ['/api/auth/login'],
    evidence: {
      request: {
        method: 'POST',
        url: '/api/auth/login',
        headers: { 'Content-Type': 'application/json' },
        body: '{"username": "\' OR 1=1--", "password": "any"}'
      },
      response: {
        status: 200,
        headers: { 'Content-Type': 'application/json' },
        body: '{"token": "admin-token-123"}'
      }
    },
    recommended_fixes: ['Use parameterized queries or prepared statements.'],
    attack_chain: [
      {
        step: 1,
        description: 'Attacker sends malicious payload',
        action: 'Send POST request',
        payload: { username: "' OR 1=1--" },
        endpoint: '/api/auth/login',
        expected_outcome: 'Login failure',
        actual_outcome: 'Login success as admin'
      },
      {
        step: 2,
        description: 'Database executes query',
        action: 'Execute SQL',
        expected_outcome: 'Query matches single user',
        actual_outcome: 'Query matches all users'
      },
      {
        step: 3,
        description: 'Authentication bypassed',
        action: 'Receive Token',
        expected_outcome: '401 Unauthorized',
        actual_outcome: '200 OK with admin token'
      }
    ]
  },
  {
    id: 'vuln-2',
    scan_id: 'scan-1',
    title: 'IDOR in User Profile',
    description: 'Direct Object Reference vulnerability allowing access to other users profiles by changing the ID in the URL.',
    severity: 'high',
    type: 'IDOR',

    discovered_at: new Date(Date.now() - 86400000 * 2).toISOString(),
    impact: 'High - Privacy Violation',
    exploit_complexity: 'medium',
    cvss_score: 7.5,
    affected_endpoints: ['/api/users/:id'],
    recommended_fixes: ['Implement proper access control checks to ensure the user owns the record.'],
    attack_chain: [
      {
        step: 1,
        description: 'Attacker identifies resource ID',
        action: 'Observation',
        expected_outcome: 'Random UUID',
        actual_outcome: 'Sequential Integer'
      },
      {
        step: 2,
        description: 'Attacker requests other user ID',
        action: 'GET request',
        endpoint: '/api/users/124',
        expected_outcome: '403 Forbidden',
        actual_outcome: '200 OK with data'
      }
    ]
  },
  {
    id: 'vuln-3',
    scan_id: 'scan-1',
    title: 'Missing Security Headers',
    description: 'The application is missing Content-Security-Policy and X-Frame-Options headers.',
    severity: 'low',
    type: 'Business Logic',

    discovered_at: new Date(Date.now() - 86400000 * 3).toISOString(),
    impact: 'Low - Clickjacking',
    exploit_complexity: 'high',
    cvss_score: 3.5,
    affected_endpoints: ['/*'],
    recommended_fixes: ['Configure proper HTTP security headers.'],
    attack_chain: []
  }
]

export const vulnerabilityService = {
  async getVulnerabilities(filters?: VulnerabilityFilter): Promise<Vulnerability[]> {
    await new Promise(resolve => setTimeout(resolve, 600))
    let filtered = [...mockVulnerabilities]

    if (filters?.severity) {
      filtered = filtered.filter(v => v.severity === filters.severity)
    }
    if (filters?.type) {
      filtered = filtered.filter(v => v.type === filters.type)
    }

    return filtered
  },

  async getVulnerability(id: string): Promise<Vulnerability> {
    await new Promise(resolve => setTimeout(resolve, 300))
    const vuln = mockVulnerabilities.find(v => v.id === id)
    if (!vuln) throw new Error('Vulnerability not found')
    return vuln
  },
}
